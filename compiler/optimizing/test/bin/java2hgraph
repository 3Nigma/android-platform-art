#!/bin/bash
#
# Copyright (C) 2014 The Android Open Source Project
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

echoerr() {
  echo $@ 1>&2
}

clean_up() {
  cd ${ANDROID_BUILD_TOP}
  rm -rf ${TEMP_FOLDER}
}

fail() {
  echoerr "ERROR: $0 script failed..."
  clean_up
  exit 1
}

# Parse arguments
INPUT_FILES=$@
if [ "$#" -eq 0 ]; then
  echoerr "ERROR: no input files specified"
  exit 1
fi

# Tool names
JAVAC=javac
DX=dx
DEX2OAT=dex2oat

# Temporary file/folder names
TEMP_FOLDER=`mktemp -d`
CLASS_FOLDER="${TEMP_FOLDER}/classes"
DEX_FILE="${TEMP_FOLDER}/test.dex"
OAT_FILE="${TEMP_FOLDER}/test.oat"

# Build source files
rm -rf ${CLASS_FOLDER} || fail
mkdir -p ${CLASS_FOLDER} || fail
${JAVAC} -d ${CLASS_FOLDER} ${INPUT_FILES} || fail

# Convert to DEX
${DX} -JXmx256m --dex --output=${DEX_FILE} ${CLASS_FOLDER} || fail

# Jump to the temp folder because dex2oat creates a dalvik-cache folder
cd ${TEMP_FOLDER}

# Run dex2oat and extract the HGraph
export DEX_LOCATION=`dirname "${DEX_FILE}"`
${DEX2OAT} \
  --dump-passes \
  --compiler-backend=Optimizing \
  --android-root=${ANDROID_HOST_OUT} \
  --boot-image=${ANDROID_HOST_OUT}/framework/core-optimizing.art \
  --runtime-arg -Xnorelocate \
  --dex-file=${DEX_FILE} \
  --oat-file=${OAT_FILE} 2>&1 || fail

