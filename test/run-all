LOG=`(cd ../../; echo $PWD | sed 's|.*\/||g')`
LOG=run-all-$LOG.log
echo LOG: $LOG

if [ "${1:-none}" == "none" ]; then
  ./run-all-tests --host --64 2>&1 | tee $LOG
else
  if [ ! -e $LOG ]; then
    ./run-all-tests --host --64 2>&1 | tee $LOG
  fi
fi

REASONS=`cat $LOG | grep "reason="  | sort -u`
echo "==="
FAILURES=0
for REASON in $REASONS; do
  COUNT=`cat $LOG | grep "$REASON" | wc -l`
  R=`echo $REASON | sed 's|reason=||g'`
  TESTS=`cat $LOG | grep "$R=" | sed "s|$R=||g" | sed 's|-.*||g' | sort | tr '\n' ' '`
  echo "$R: $COUNT    $TESTS"
  FAILURES=`echo $FAILURES + $COUNT | bc`
done
echo "==="
FAILED=`cat $LOG | grep "failed tests:" | sed 's|failed tests: ||g'`
PASSED=`cat $LOG | grep "succeeded tests:" | sed 's|succeeded tests: ||g'`
TOTAL=` echo $PASSED + $FAILED | bc`
echo "FAILURES: $FAILURES/$FAILED"
echo "PASSED $PASSED of $TOTAL"

#COMPILATION_RATE=`cat $LOG | grep "Compilation Rate" | sed 's|.*Compilation Rate: ||g'`
#METHODS_TOTAL=0
#METHODS_COMPILED=0
#while read line
#do
#  total=`echo $line | awk -F " " '{print $3}'`
#  compiled=`echo $line | awk -F " " '{print $1}'`
#  METHODS_TOTAL=`echo $METHODS_TOTAL + $total | bc`
#  METHODS_COMPILED=`echo $METHODS_COMPILED + $compiled | bc`
#done <<< "$COMPILATION_RATE"
#if [ "$METHODS_TOTAL" == "0" ]; then
#  percent=0
#else
#  percent=`echo "$METHODS_COMPILED/$METHODS_TOTAL*100" | bc -l | sed 's|\..*$||g'`
#fi
#echo "Summary Compilation Rate: $METHODS_COMPILED of $METHODS_TOTAL ($percent%)"
